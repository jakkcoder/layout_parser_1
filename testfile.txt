SELECT
  job_id,
  user_email,
  SUM(total_slots) AS total_slots,
  SUM(total_bytes_processed) AS total_bytes,
  SUM(cost_per_slot) AS total_cost_slots,
  SUM(cost_per_byte) AS total_cost_bytes,
  SUM(total_cost) AS total_combined_cost
FROM (
  SELECT
    job_id,
    user_email,
    (total_slot_ms / 1000 / 60 / 60) AS total_slots,  -- Compute time in hours assuming one slot equals one hour
    total_bytes_processed,
    ROUND(((total_slot_ms / 1000 / 60 / 60) * slot_rate), 2) AS cost_per_slot,  -- Cost calculation per slot
    ROUND((total_bytes_processed / 1024 / 1024 / 1024) * byte_rate, 2) AS cost_per_byte,  -- Cost calculation per GB
    ROUND(((total_slot_ms / 1000 / 60 / 60) * slot_rate) + ((total_bytes_processed / 1024 / 1024 / 1024) * byte_rate), 2) AS total_cost  -- Combined total cost
  FROM
    region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT
  WHERE
    total_slot_ms IS NOT NULL AND
    TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) != 0 AND
    end_time > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
) derived
GROUP BY
  user_email
ORDER BY
  total_combined_cost DESC;
