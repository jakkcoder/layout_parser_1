# Fetch 1000 account IDs
fetch_query = """
SELECT DISTINCT id_accountId
FROM e2e_foundation_audit.audit
WHERE DATE(COALESCE(meta_updated, meta_created)) >= DATE_SUB(CURRENT_DATE, 7)
LIMIT 1000;
"""
account_ids = spark.sql(fetch_query).collect()
ids_list = [row['id_accountId'] for row in account_ids]
ids_str = ', '.join(map(str, ids_list))

# Use the IDs in your main query
main_query = f"""
SELECT 
    audit.id_accountId, 
    audit.txTypeId, 
    COALESCE(audit.meta_updated, audit.meta_created) AS audit_date, 
    audit.actionTypeId, 
    audit.listTypeId, 
    audit.meta_updatedByUser_id, 
    audit.entityType, 
    audit.auditId, 
    audit.entityAmount
FROM 
    e2e_foundation_audit.audit audit 
WHERE 
    audit.id_accountID IN ({ids_str}) 
    AND DATE(COALESCE(audit.meta_updated, audit.meta_created)) >= DATE_SUB(CURRENT_DATE, 7) 
GROUP BY 
    1, 2, 3, 4, 5, 6, 7, 8, 9 
LIMIT 50;
"""
