SELECT 
  user_email,
  SUM(total_slot_ms) / (3600000) AS num_slot,
  SUM(jobs.total_bytes_billed) / (1024 * 1024 * 1024) * 5 AS cost,
  STRING_AGG(query, ', ') AS query
FROM (
  SELECT 
    user_email,
    total_slot_ms,
    jobs.total_bytes_billed,
    query,
    ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY jobs.total_bytes_billed DESC) AS query_rank
  FROM 
    `region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT` jobs
  WHERE 
    jobs.creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
    AND job_type = 'QUERY'
) ranked_queries
WHERE query_rank <= 2
GROUP BY user_email
HAVING cost > 0.01
ORDER BY cost DESC;

