WITH user_costs AS (
  SELECT 
    user_email,
    SUM((total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND)) * 0.008 * (TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) / (1000 * 60 * 60))) AS cost
  FROM 
    `region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT` jobs
  WHERE 
    jobs.creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
    AND job_type = 'QUERY'
  GROUP BY 
    user_email
),
top_queries AS (
  SELECT 
    user_email,
    STRING_AGG(query, '\n\n') AS query
  FROM (
    SELECT 
      user_email,
      query,
      ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY jobs.total_bytes_billed DESC) AS query_rank
    FROM 
      `region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT` jobs
    WHERE 
      jobs.creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
      AND job_type = 'QUERY'
  ) ranked_queries
  WHERE query_rank <= 2
  GROUP BY user_email
)
SELECT 
  user_costs.user_email,
  user_costs.cost,
  top_queries.query
FROM 
  user_costs
JOIN 
  top_queries
ON 
  user_costs.user_email = top_queries.user_email
WHERE 
  user_costs.cost > 0.01
ORDER BY 
  user_costs.cost DESC;
