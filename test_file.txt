WITH current_week AS (
    SELECT
        query,
        (total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND)) as Total_slots,
        (TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) / (1000 * 60 * 60)) as Query_Duration,
        (total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) * .87 * (TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) / (1000 * 60 * 60))) AS cost,
        start_time,
        end_time
    FROM
        `region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT` jobs
    WHERE
        user_email = '{user}'
        AND jobs.creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
        AND job_type = 'QUERY'
),
previous_week AS (
    SELECT
        query,
        (total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND)) as Total_slots,
        (TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) / (1000 * 60 * 60)) as Query_Duration,
        (total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) * .87 * (TIMESTAMP_DIFF(end_time, start_time, MILLISECOND) / (1000 * 60 * 60))) AS cost,
        start_time,
        end_time
    FROM
        `region-asia-east2.INFORMATION_SCHEMA.JOBS_BY_PROJECT` jobs
    WHERE
        user_email = '{user}'
        AND jobs.creation_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 14 DAY)
        AND jobs.creation_time < TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
        AND job_type = 'QUERY'
),
weekly_data AS (
    SELECT
        current_week.query,
        current_week.Total_slots,
        current_week.Query_Duration,
        current_week.cost AS current_cost,
        COALESCE(previous_week.cost, 0) AS previous_cost,
        (current_week.cost - COALESCE(previous_week.cost, 0)) AS cost_increment,
        (SUM(current_week.Total_slots) OVER() / (1000 * 60 * 60)) AS billed_hours
    FROM
        current_week
    LEFT JOIN
        previous_week
    ON
        current_week.query = previous_week.query
)
SELECT
    query,
    Total_slots,
    Query_Duration,
    current_cost AS cost,
    cost_increment,
    billed_hours
FROM
    weekly_data
ORDER BY
    cost DESC
LIMIT 2;
